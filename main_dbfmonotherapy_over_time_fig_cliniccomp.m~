close all
clear all

%Add a path to the directory that contains the model details
dae_location = strcat(pwd,'/auxiliary_files_model_setup');
addpath(dae_location);

M = eye(36);
super_compound_list_index=get_conslaw_position();
%Substitute in cons. laws 
for i=1:size(M,1)
    if(ismember(i,super_compound_list_index))
        M(i,i)=0; 
    end
end

% Set non-changing inital conditions
MEK_tot=1.2;
ERK_tot=1.2;
phosph1_tot=0.0003;
phosph2_tot=0.12;
y0=zeros(size(M,1),1);
y0(4)=MEK_tot;
y0(20)=ERK_tot; 
y0(12)=phosph1_tot;
y0(27)=phosph2_tot;
TMT_tot=0;
y0(30)=TMT_tot;
TMT_in=TMT_tot;


dbfdose = linspace(0,1.9246,100);
dbfresponse=zeros(1,length(dbfdose));

options = odeset('Mass',M,'MassSingular','yes', 'RelTol',1e-4,'AbsTol',1e-4);
set(gcf,'position',[100,100,1000,600])
newcolors = {'#008000',' #FFC300 ', '#FF5733 ','#C70039','#900C3F','#581845','#000000','#DAF7A6'};

%%%%%%%%%%%%%%%%%%%%%%% 

colororder(newcolors)

%%%
% inputM=[12,1,0.600000000000000,0.106269508525671;
%     24,0.600000000000000,0.600000000000000,0.110547458838431;
%     12,0.600000000000000,1,0.111451531173382;%
%     36,0.200000000000000,1.40000000000000,0.119840815096542;
%     24,1.40000000000000,0.200000000000000,0.125296872073478];
% 
% inputM=[12,0.400000000000000,1.70000000000000,0.104791289445504;
%     18,0.300000000000000,1.70000000000000,0.105182666181767;
%     30,0.200000000000000,1.80000000000000,0.105736423096753;
%     24,1.60000000000000,0.200000000000000,0.106139745098948];

% inputM=[12,0.400000000000000,1.70000000000000,0.104791289445504;13,0.400000000000000,1.60000000000000,0.104956913354938;14,0.400000000000000,1.50000000000000,0.105091357192443;17,0.300000000000000,1.80000000000000,0.105100731435990;18,0.300000000000000,1.70000000000000,0.105182666181767;12,0.500000000000000,1.30000000000000,0.105288226704788;17,0.400000000000000,1.30000000000000,0.105584624528772;12,0.700000000000000,0.900000000000000,0.105715083742968;30,0.200000000000000,1.80000000000000,0.105736423096753;20,0.300000000000000,1.60000000000000,0.105757583041466;15,0.400000000000000,1.40000000000000,0.105760572148801;21,0.300000000000000,1.50000000000000,0.105766017906790;19,0.400000000000000,1.20000000000000,0.105834907676223;20,1.80000000000000,0.200000000000000,0.105888687429968;15,0.500000000000000,1.10000000000000,0.105916613604576;13,0.600000000000000,1,0.105921921024518;14,0.800000000000000,0.700000000000000,0.105933726149296;14,0.500000000000000,1.20000000000000,0.105950109538532;23,0.300000000000000,1.40000000000000,0.105973672150243;26,1.50000000000000,0.200000000000000,0.105987509505317];

%inputM=[12,0.600000000000000,1.10000000000000,0.105987681656264;32,0.200000000000000,1.70000000000000,0.106005260311727;22,1.70000000000000,0.200000000000000,0.106012082325559;29,1.40000000000000,0.200000000000000,0.106029963009422;19,0.300000000000000,1.60000000000000,0.106035737369095;21,0.400000000000000,1.10000000000000,0.106078878270456;14,0.700000000000000,0.800000000000000,0.106095498985011;12,1.20000000000000,0.500000000000000,0.106110700095758;20,0.500000000000000,0.900000000000000,0.106136311711022;24,1.60000000000000,0.200000000000000,0.106139745098948;17,0.700000000000000,0.700000000000000,0.106144582579113;18,0.600000000000000,0.800000000000000,0.106146070257475;14,1.30000000000000,0.400000000000000,0.106164403849303;15,0.600000000000000,0.900000000000000,0.106167845691528;32,1.30000000000000,0.200000000000000,0.106168626001407;18,1.40000000000000,0.300000000000000,0.106173190444608;35,0.200000000000000,1.60000000000000,0.106179201801708;26,0.300000000000000,1.30000000000000,0.106179377838222;36,1.20000000000000,0.200000000000000,0.106193904916226;16,1.20000000000000,0.400000000000000,0.106219522047730;15,1.60000000000000,0.300000000000000,0.106226526636429;17,0.500000000000000,1,0.106235131426837;12,0.800000000000000,0.800000000000000,0.106237014373633;12,0.900000000000000,0.700000000000000,0.106242958483258;17,0.800000000000000,0.600000000000000,0.106246195624608;24,0.400000000000000,1,0.106247750866582;18,1.10000000000000,0.400000000000000,0.106253392000522;12,1,0.600000000000000,0.106269508525671;33,0.200000000000000,1.70000000000000,0.106355156099170;20,1.30000000000000,0.300000000000000,0.106370404937299;24,0.900000000000000,0.400000000000000,0.106394909847635;16,1.50000000000000,0.300000000000000,0.106404344091551;18,0.900000000000000,0.500000000000000,0.106404441147953;16,0.300000000000000,1.80000000000000,0.106420501068260;21,0.700000000000000,0.600000000000000,0.106421648503109;22,0.300000000000000,1.50000000000000,0.106434569026146;29,1,0.300000000000000,0.106435599182861;21,1,0.400000000000000,0.106470943571459;16,0.400000000000000,1.40000000000000,0.106475159926087;23,0.500000000000000,0.800000000000000,0.106498983346020;29,0.200000000000000,1.80000000000000,0.106500337682264;24,0.300000000000000,1.40000000000000,0.106500713146498;21,0.600000000000000,0.700000000000000,0.106502373803410;16,1,0.500000000000000,0.106505025792360;26,1.10000000000000,0.300000000000000,0.106507565252744;29,0.300000000000000,1.20000000000000,0.106509242427657;32,0.300000000000000,1.10000000000000,0.106517624508344;14,0.900000000000000,0.600000000000000,0.106519613836612;28,0.300000000000000,1.20000000000000,0.106535174081829;26,0.700000000000000,0.500000000000000,0.106554134319062;28,1.40000000000000,0.200000000000000,0.106565518295264;22,0.800000000000000,0.500000000000000,0.106588969359682;25,0.300000000000000,1.30000000000000,0.106594846815292;26,0.600000000000000,0.600000000000000,0.106609103385695;34,0.900000000000000,0.300000000000000,0.106609259490983;23,1.20000000000000,0.300000000000000,0.106643335658492;25,1.10000000000000,0.300000000000000,0.106643441608492;13,0.500000000000000,1.20000000000000,0.106676811455480;13,1.40000000000000,0.400000000000000,0.106678327273350;35,1.20000000000000,0.200000000000000,0.106708785443826;28,0.400000000000000,0.900000000000000,0.106714905618106;27,0.400000000000000,0.900000000000000,0.106719665126383;28,0.500000000000000,0.700000000000000,0.106719904858773;31,0.200000000000000,1.80000000000000,0.106720341892101;14,1.70000000000000,0.300000000000000,0.106734841096905;34,0.200000000000000,1.60000000000000,0.106735909748340;29,0.800000000000000,0.400000000000000,0.106741714961741;32,0.400000000000000,0.800000000000000,0.106746068994350;14,1.10000000000000,0.500000000000000,0.106748364863649;30,1,0.300000000000000,0.106749292936447;18,0.500000000000000,1,0.106760506603762;12,1.80000000000000,0.300000000000000,0.106766812745194;28,0.800000000000000,0.400000000000000,0.106783474483908;36,0.300000000000000,1,0.106811965384384;33,0.600000000000000,0.500000000000000,0.106836680845375;23,1.60000000000000,0.200000000000000,0.106839836321600;33,1.30000000000000,0.200000000000000,0.106853244139525;36,0.200000000000000,1.60000000000000,0.106879307136959;34,0.500000000000000,0.600000000000000,0.106888639502840;22,1.20000000000000,0.300000000000000,0.106896485952405];

inputM=[8, 1, 1, 0;
    8, 3.3333, 1, 0];
    
    

setEndTime=3600*inputM(:,1);
setBRAF=0.003*inputM(:,2);
setATP=1000*inputM(:,3);

for v = 1:length(inputM)
    tspan = [0 setEndTime(v)];    
    BRAF_tot=setBRAF(v);
    y0(1)=BRAF_tot;
    ATP_tot=setATP(v);        
    y0(2)=ATP_tot;

    for d = 1:length(dbfdose)
        DBF_in=dbfdose(d);
        y0(15)=DBF_in; 
        [t,y] = ode15s(@(t,y) mapk_cascade_DAE(y, BRAF_tot, ATP_tot, DBF_in, TMT_in), tspan, y0, options);
        yperk = y(end,22);
        ypperk = y(end,26);
        dbfresponse(d)=(yperk+ypperk)/1.2;
    end

    dbfresponse=dbfresponse/dbfresponse(1);
    hold on
    plot(dbfdose,dbfresponse,'LineWidth',2)

end





%[ng]=[mol/liter]*[mL]*[g/mol]*1000(to make it nano)
%effconc = dbfdose*0.001*519.6*1000;
%[0:200:1000]/(0.001*519.6*1000);

 
yticks([0:0.2:1])
yticklabels({'-100','-80','-60','-40','-20','0'})
ylim([0 1])
xticks([0:200:1000]/(0.001*519.6*1000))
xticklabels({'0','200','400','600','800','1000'})
xlim([0 dbfdose(end)])
xlabel('Dabrafenib concebtration (ng/mL)','FontSize',18)
ylabel('Change in phosphorylated ERK','FontSize',18)
% a = get(gca,'XTickLabel');
% set(gca,'XTickLabel',a,'fontsize',14)
% 
% 
% grid on

%https://apps.automeris.io/wpd/
data=[137.3913043478261, 62.32365145228215
177.97101449275362, 50.0414937759336
206.95652173913044, 19.170124481327804
404.05797101449275, 11.203319502074692
559.4202898550725, 6.721991701244804
573.3333333333333, 20
724.0579710144928, 10.871369294605813
906.086956521739, 13.360995850622416];

xdata = data(:,1)/(0.001*519.6*1000);
ydata = data(:,2)/100;

hold on
scatter(xdata,ydata,'k','LineWidth',2)


hold on
dbfeff=1:1:1000;%dbfdose*(0.001*519.6*1000);
Emax=1;
ic50=134;
resp = 100.*(1-Emax.*dbfeff./(ic50+dbfeff));

dbfeff_mod = dbfeff/(0.001*519.6*1000);
resp_mod=resp/100;

%EMAX
%plot(dbfeff_mod,resp_mod,'k--','LineWidth',2)

%%%% compute rmse foolbacher
rmse_xcheckpoints = zeros(length(xdata),1);
for i = 1:length(xdata)
   rmse_xcheckpoints(i)=find(dbfeff_mod > xdata(i), 1);
end
rmsematrix=zeros(length(xdata),3);
rmsematrix(:,1)=xdata;
for dx = 1:length(rmse_xcheckpoints)
    rmsematrix(dx,2)=dbfeff_mod( rmse_xcheckpoints(dx)-1) ;
    rmsematrix(dx,3)=dbfeff_mod( rmse_xcheckpoints(dx)) ;
end
ymodelvector = zeros(1,length(ydata));
for yi = 1:length(ymodelvector)
    ymodelvector(yi) = (resp_mod(rmse_xcheckpoints(yi)-1) + resp_mod(rmse_xcheckpoints(yi)) )/2;
end

rmse_emax = sqrt(mean((ydata(:)- ymodelvector(:)).^2)); %=0.1115
%%%


 legend('BRAF = 3nM','BRAF = 10nM','patient data')
% ,...
%     'Position',[0 100 0 50],'Orientation','horizontal','FontSize',16)